import{r as b,W as C,j as e,h as T}from"./index-OnCL7RT-.js";import"./vendor-CMJYdXG8.js";const S=n=>{const r=n.trim().split(`
`),t=[],a=r[0].toLowerCase(),s=a.includes("peso")||a.includes("weight")||a.includes("brinco")?1:0;for(let l=s;l<r.length;l++){const m=r[l].trim();if(!m)continue;const c=m.split(/[,;\t]/).map(i=>i.trim());let u,x,f=new Date;c.forEach(i=>{const h=parseFloat(i.replace(",","."));if(!isNaN(h)&&h>10&&h<2e3)u=h;else if(/^[A-Z0-9]{2,10}$/i.test(i))x=i.toUpperCase();else if(/\d{2}[\/\-]\d{2}[\/\-]\d{2,4}/.test(i)){const g=I(i);g&&(f=g)}}),u&&t.push({id:`scale-${Date.now()}-${l}`,timestamp:f,weight:u,unit:"kg",animalBrinco:x,matched:!1})}return t},E=n=>{var a,d,s,l;const r=n.trim().split(`
`),t=[];for(let m=1;m<r.length;m++){const c=r[m].split(",");if(c.length<2)continue;const u=(a=c[0])==null?void 0:a.trim(),x=parseFloat((d=c[1])==null?void 0:d.replace(",",".")),f=(s=c[2])==null?void 0:s.trim(),i=(l=c[3])==null?void 0:l.trim();if(isNaN(x))continue;let h=new Date;if(f){const g=I(f);if(g&&(h=g,i)){const[j,y]=i.split(":").map(Number);h.setHours(j||0,y||0)}}t.push({id:`tru-${Date.now()}-${m}`,timestamp:h,weight:x,unit:"kg",animalBrinco:u||void 0,matched:!1})}return t},R=n=>S(n),I=n=>{const r=n.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{2,4})/);if(r){const a=parseInt(r[1]),d=parseInt(r[2])-1;let s=parseInt(r[3]);return s<100&&(s+=2e3),new Date(s,d,a)}const t=n.match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);return t?new Date(parseInt(t[1]),parseInt(t[2])-1,parseInt(t[3])):null},A=(n,r)=>{const t=r.toLowerCase();return t.includes("tru-test")||t.includes("trutest")?"tru-test":t.includes("gallagher")?"gallagher":t.endsWith(".csv")?"csv":t.endsWith(".txt")?"txt":"generic"},D=async n=>new Promise((r,t)=>{const a=new FileReader;a.onload=d=>{var s;try{const l=(s=d.target)==null?void 0:s.result,m=A(l,n.name);let c;switch(m){case"tru-test":c=E(l);break;case"gallagher":c=R(l);break;default:c=S(l)}r(c)}catch{t(new Error("Erro ao processar arquivo de balanÃ§a"))}},a.onerror=()=>t(new Error("Erro ao ler arquivo")),a.readAsText(n)}),F=(n,r)=>{const t=new Map;r.forEach(s=>{t.set(s.brinco.toUpperCase(),s),s.nome&&t.set(s.nome.toUpperCase(),s)});let a=0;const d=n.map(s=>{if(s.animalBrinco){const l=t.get(s.animalBrinco.toUpperCase());if(l)return a++,{...s,matched:!0,animalId:l.id}}return s});return{total:n.length,matched:a,unmatched:n.length-a,readings:d}},L=()=>["brinco,peso_kg,data",...["ABC001,320.5,15/01/2025","ABC002,285.0,15/01/2025","ABC003,410.2,15/01/2025"]].join(`
`),U=()=>{const n=L(),r=new Blob([n],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(r),a=document.createElement("a");a.href=t,a.download="template_balanca.csv",a.click(),URL.revokeObjectURL(t)},P=({isOpen:n,onClose:r,animals:t,onImportComplete:a})=>{const[d,s]=b.useState("upload"),[l,m]=b.useState([]),[c,u]=b.useState(null),[x,f]=b.useState(C.None),[i,h]=b.useState(!1),[g,j]=b.useState(null),y=b.useCallback(async o=>{var w;const p=(w=o.target.files)==null?void 0:w[0];if(p){h(!0),j(null);try{const N=await D(p),v=F(N,t);m(v.readings),u({matched:v.matched,unmatched:v.unmatched,total:v.total}),s("review")}catch{j("Erro ao processar arquivo. Verifique o formato.")}finally{h(!1)}}},[t]),B=b.useCallback(()=>{const o=new Map;l.filter(p=>p.matched&&p.animalId).forEach(p=>{o.set(p.animalId,{weight:p.weight,date:p.timestamp,type:x})}),a(o),k()},[l,x,a]),k=()=>{s("upload"),m([]),u(null),j(null),r()};return e.jsx(T,{isOpen:n,onClose:k,title:"Importar Dados da BalanÃ§a",children:e.jsxs("div",{className:"space-y-4",children:[d==="upload"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-6xl mb-4",children:"âš–ï¸"}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Importar Arquivo de BalanÃ§a"}),e.jsx("p",{className:"text-gray-400 text-sm mb-6",children:"Suporte para CSV, TXT e formatos Tru-Test, Gallagher"}),e.jsxs("label",{className:"inline-block",children:[e.jsx("input",{type:"file",accept:".csv,.txt",onChange:y,className:"hidden",disabled:i}),e.jsx("span",{className:"px-6 py-3 bg-brand-primary text-white rounded-lg cursor-pointer hover:bg-brand-primary-dark transition-colors inline-block",children:i?"Processando...":"Selecionar Arquivo"})]}),g&&e.jsx("p",{className:"text-red-400 text-sm mt-4",children:g})]}),e.jsxs("div",{className:"border-t border-base-700 pt-4",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-2",children:"Formato esperado do arquivo:"}),e.jsxs("code",{className:"block bg-base-900 p-3 rounded text-xs text-gray-300",children:["brinco,peso_kg,data",e.jsx("br",{}),"ABC001,320.5,15/01/2025",e.jsx("br",{}),"ABC002,285.0,15/01/2025"]}),e.jsx("button",{onClick:U,className:"mt-3 text-sm text-brand-primary hover:underline",children:"ðŸ“¥ Baixar modelo de arquivo"})]})]}),d==="review"&&c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{className:"bg-base-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:c.total}),e.jsx("p",{className:"text-xs text-gray-400",children:"Total"})]}),e.jsxs("div",{className:"bg-green-900/30 rounded-lg p-3",children:[e.jsx("p",{className:"text-2xl font-bold text-green-400",children:c.matched}),e.jsx("p",{className:"text-xs text-gray-400",children:"Encontrados"})]}),e.jsxs("div",{className:"bg-red-900/30 rounded-lg p-3",children:[e.jsx("p",{className:"text-2xl font-bold text-red-400",children:c.unmatched}),e.jsx("p",{className:"text-xs text-gray-400",children:"NÃ£o encontrados"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"Tipo de Pesagem"}),e.jsx("select",{value:x,onChange:o=>f(o.target.value),className:"w-full px-3 py-2 bg-base-700 border border-base-600 rounded-lg text-white",children:Object.values(C).map(o=>e.jsx("option",{value:o,children:o},o))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-400 mb-2",children:"Leituras"}),e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-1",children:l.map((o,p)=>{const w=o.animalId?t.find(N=>N.id===o.animalId):null;return e.jsxs("div",{className:`flex justify-between items-center p-2 rounded ${o.matched?"bg-green-900/20":"bg-red-900/20"}`,children:[e.jsxs("div",{children:[e.jsx("span",{className:o.matched?"text-white":"text-red-400",children:o.animalBrinco||"Sem brinco"}),w&&e.jsxs("span",{className:"text-gray-400 text-xs ml-2",children:["(",w.nome||"sem nome",")"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("span",{className:"text-white font-medium",children:[o.weight," kg"]}),e.jsx("span",{className:"text-gray-500 text-xs block",children:new Date(o.timestamp).toLocaleDateString("pt-BR")})]})]},p)})})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx("button",{onClick:()=>s("upload"),className:"flex-1 px-4 py-2 bg-base-700 text-white rounded-lg hover:bg-base-600",children:"Voltar"}),e.jsxs("button",{onClick:B,disabled:c.matched===0,className:"flex-1 px-4 py-2 bg-brand-primary text-white rounded-lg hover:bg-brand-primary-dark disabled:opacity-50",children:["Importar ",c.matched," Pesagens"]})]})]})]})})};export{P as default};
