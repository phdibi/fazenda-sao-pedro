import{S as b,_ as E,c as x}from"./index-OnCL7RT-.js";class O{constructor(){this.cache=new Map,this.maxAge=1800*1e3,this.maxEntries=50}hash(t){let s=0;for(let d=0;d<t.length;d++){const o=t.charCodeAt(d);s=(s<<5)-s+o,s=s&s}return s.toString(36)}normalizeQuery(t){return t.toLowerCase().trim().replace(/\s+/g," ").replace(/[.,!?]/g,"")}get(t){const s=this.normalizeQuery(t),d=this.hash(s),o=this.cache.get(d);return o?Date.now()-o.timestamp>this.maxAge?(this.cache.delete(d),null):o.response:null}set(t,s){const d=this.normalizeQuery(t),o=this.hash(d);if(this.cache.size>=this.maxEntries){const e=this.cache.keys().next().value;this.cache.delete(e)}this.cache.set(o,{response:s,timestamp:Date.now(),hash:o})}clear(){this.cache.clear()}}const v=new O,y={calls:15,windowMs:60*1e3};let I={callCount:0,windowStart:Date.now()};const G=()=>{const a=Date.now();if(a-I.windowStart>y.windowMs&&(I={callCount:0,windowStart:a}),I.callCount>=y.calls)throw new Error("â³ Limite de IA atingido. Aguarde 1 minuto.");I.callCount++};let N=null,n=null;const K=async()=>{if(!n){const a=await E(()=>import("./gemini-Cs4yGXwm.js"),[]);return n=a.Type,a.GoogleGenAI}return null},T=async()=>{if(N)return N;try{throw new Error("VITE_GEMINI_API_KEY nÃ£o encontrada")}catch{throw new Error("NÃ£o foi possÃ­vel conectar Ã  IA")}},D="gemini-2.5-flash",z=()=>({type:(n==null?void 0:n.OBJECT)||"OBJECT",properties:{medicamento:{type:(n==null?void 0:n.STRING)||"STRING"},dose:{type:(n==null?void 0:n.NUMBER)||"NUMBER"},unidade:{type:(n==null?void 0:n.STRING)||"STRING",enum:["ml","mg","dose"]},motivo:{type:(n==null?void 0:n.STRING)||"STRING"}}}),F=()=>({type:(n==null?void 0:n.OBJECT)||"OBJECT",properties:{brinco:{type:(n==null?void 0:n.STRING)||"STRING"},nome:{type:(n==null?void 0:n.STRING)||"STRING"},raca:{type:(n==null?void 0:n.STRING)||"STRING",enum:Object.values(x)},sexo:{type:(n==null?void 0:n.STRING)||"STRING",enum:Object.values(b)},dataNascimento:{type:(n==null?void 0:n.STRING)||"STRING"},pesoKg:{type:(n==null?void 0:n.NUMBER)||"NUMBER"},maeNome:{type:(n==null?void 0:n.STRING)||"STRING"},paiNome:{type:(n==null?void 0:n.STRING)||"STRING"}}}),C=new Map;async function P(a,t,s=500){const d=C.get(a);if(d)return d;const o=t().finally(()=>{setTimeout(()=>C.delete(a),s)});return C.set(a,o),o}const V=async a=>{const t=v.get(`med:${a}`);return t||P(`med:${a}`,async()=>{G();try{const d=await(await T()).models.generateContent({model:D,contents:`Extraia as informaÃ§Ãµes de medicaÃ§Ã£o do seguinte texto: "${a}"`,config:{responseMimeType:"application/json",responseSchema:z()}}),o=JSON.parse(d.text.trim());return v.set(`med:${a}`,o),o}catch{throw new Error("A IA nÃ£o conseguiu processar o comando")}})},B=async a=>{const t=v.get(`animal:${a}`);return t||P(`animal:${a}`,async()=>{G();try{const d=await(await T()).models.generateContent({model:D,contents:`Extraia as informaÃ§Ãµes de registro do animal do seguinte texto: "${a}"`,config:{responseMimeType:"application/json",responseSchema:F()}});let o=JSON.parse(d.text.trim());return o.dataNascimento&&typeof o.dataNascimento=="string"&&(o.dataNascimento=new Date(o.dataNascimento+"T00:00:00")),v.set(`animal:${a}`,o),o}catch{throw new Error("A IA nÃ£o conseguiu processar o registro")}})},k=async(a,t)=>{const s=`report:${a.length}:${t.start.getTime()}:${t.end.getTime()}`,d=v.get(s);if(d)return d;const e=a.map(h=>({...h,historicoSanitario:h.historicoSanitario.filter(f=>{const g=new Date(f.dataAplicacao);return g>=t.start&&g<=t.end})})).filter(h=>h.historicoSanitario.length>0),r=j(e),i=L(a),l={sanitary:r,reproductive:i};return v.set(s,l),l};function j(a){var w,A,R;if(a.length===0)return{topTreatedAnimals:[],medicationUsage:[],seasonalAnalysis:[],reasonAnalysis:[],recommendations:"Nenhuma atividade sanitÃ¡ria registrada no perÃ­odo."};const t=a.map(m=>({animalId:m.id,brinco:m.brinco,nome:m.nome||"N/A",treatmentCount:m.historicoSanitario.length})).sort((m,c)=>c.treatmentCount-m.treatmentCount).slice(0,20),s={};a.forEach(m=>{m.historicoSanitario.forEach(c=>{const p=new Date(c.dataAplicacao),u=`${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,"0")}`;s[c.medicamento]||(s[c.medicamento]={total:0,months:{}}),s[c.medicamento].total+=1,s[c.medicamento].months[u]=(s[c.medicamento].months[u]||0)+1})});const d=Object.entries(s).map(([m,c])=>({label:m,value:c.total,monthlyUsage:Object.entries(c.months).map(([p,u])=>{const[$,S]=p.split("-");return{label:new Date(parseInt($),parseInt(S)-1).toLocaleString("pt-BR",{month:"short",year:"numeric"}),value:u}}).sort((p,u)=>p.label.localeCompare(u.label))})).sort((m,c)=>c.value-m.value),o={};a.forEach(m=>{m.historicoSanitario.forEach(c=>{o[c.motivo]=(o[c.motivo]||0)+1})});const e=Object.entries(o).map(([m,c])=>({label:m,value:c})).sort((m,c)=>c.value-m.value),r={};a.forEach(m=>{m.historicoSanitario.forEach(c=>{const p=new Date(c.dataAplicacao),u=`${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,"0")}`;r[u]||(r[u]={total:0,meds:{}}),r[u].total+=1,r[u].meds[c.medicamento]=(r[u].meds[c.medicamento]||0)+1})});const i=Object.entries(r).map(([m,c])=>{const[p,u]=m.split("-");return{label:new Date(parseInt(p),parseInt(u)-1).toLocaleString("pt-BR",{month:"short",year:"numeric"}),value:c.total,medications:Object.entries(c.meds).map(([$,S])=>({label:$,value:S})).sort(($,S)=>S.value-$.value).slice(0,5)}}).sort((m,c)=>m.label.localeCompare(c.label)),l=((w=e[0])==null?void 0:w.label)||"motivos diversos",h=((A=d[0])==null?void 0:A.label)||"nenhum em particular",f=((R=t[0])==null?void 0:R.brinco)||"N/A",g=`Com base nos dados, observamos concentraÃ§Ã£o de tratamentos por **${l}**. O medicamento mais utilizado foi **${h}**. AtenÃ§Ã£o ao animal **${f}** que recebeu mais tratamentos. Avalie protocolos preventivos nos meses de maior incidÃªncia.`;return{topTreatedAnimals:t,medicationUsage:d,seasonalAnalysis:i,reasonAnalysis:e,recommendations:g}}function L(a){var e;const s=a.filter(r=>r.sexo===b.Femea&&r.historicoProgenie&&r.historicoProgenie.length>0).map(r=>{const i=r.historicoProgenie,l=h=>{const f=i.map(g=>g[h]).filter(g=>g!=null&&g>0);if(f.length!==0)return f.reduce((g,w)=>g+w,0)/f.length};return{damId:r.id,damBrinco:r.brinco,damNome:r.nome,offspringCount:i.length,avgBirthWeight:l("birthWeightKg"),avgWeaningWeight:l("weaningWeightKg"),avgYearlingWeight:l("yearlingWeightKg")}}).sort((r,i)=>i.offspringCount-r.offspringCount),d=s[0],o=d?`A matriz **${d.damNome||`brinco ${d.damBrinco}`}** Ã© a mais produtiva com **${d.offspringCount} crias**. MÃ©dia de desmame: **${((e=d.avgWeaningWeight)==null?void 0:e.toFixed(2))||"N/A"} kg**. Use esta genÃ©tica como base.`:"Dados insuficientes. Registre nascimentos e pesos para obter insights.";return{performanceData:s,recommendations:o}}const W=async a=>{const t={total:a.length,machos:a.filter(o=>o.sexo===b.Macho).length,femeas:a.filter(o=>o.sexo===b.Femea).length,pesoMedio:a.length>0?a.reduce((o,e)=>o+e.pesoKg,0)/a.length:0,pesoTotal:a.reduce((o,e)=>o+e.pesoKg,0),maisPesado:a.reduce((o,e)=>e.pesoKg>o.pesoKg?e:o,a[0]),maisLeve:a.reduce((o,e)=>e.pesoKg<o.pesoKg?e:o,a[0]),comVacinacao:a.filter(o=>{var e;return(e=o.historicoSanitario)==null?void 0:e.some(r=>{var i,l;return((i=r.motivo)==null?void 0:i.toLowerCase().includes("vacin"))||((l=r.medicamento)==null?void 0:l.toLowerCase().includes("vacin"))})}).length,comTratamento:a.filter(o=>o.historicoSanitario&&o.historicoSanitario.length>0).length,prenhas:a.filter(o=>o.sexo===b.Femea&&o.historicoPrenhez&&o.historicoPrenhez.length>0).length,comProgenie:a.filter(o=>o.historicoProgenie&&o.historicoProgenie.length>0).length,racas:a.reduce((o,e)=>(o[e.raca]=(o[e.raca]||0)+1,o),{}),ativos:a.filter(o=>o.status==="Ativo").length,vendidos:a.filter(o=>o.status==="Vendido").length},s=()=>{const o=new Date,e=a.filter(r=>r.dataNascimento).map(r=>{const i=new Date(r.dataNascimento);return(o.getTime()-i.getTime())/(1e3*60*60*24*30)});return e.length>0?e.reduce((r,i)=>r+i,0)/e.length:0};return{sendMessage:async o=>{const e=o.toLowerCase();if(e.includes("olÃ¡")||e.includes("oi")||e.includes("hey")||e.includes("bom dia")||e.includes("boa tarde")||e.includes("boa noite"))return"OlÃ¡! Sou o Titi, seu assistente de manejo. ğŸ„ Posso ajudar com informaÃ§Ãµes sobre seu rebanho, pesagens, vacinas, reproduÃ§Ã£o e muito mais!";if(e.includes("ajuda")||e.includes("help")||e.includes("o que vocÃª pode"))return`Posso responder sobre:
â€¢ Quantidade de animais (machos, fÃªmeas, total)
â€¢ Peso mÃ©dio, mais pesado, mais leve
â€¢ VacinaÃ§Ã£o e tratamentos
â€¢ Prenhez e reproduÃ§Ã£o
â€¢ RaÃ§as do rebanho
â€¢ Idade mÃ©dia
â€¢ Status (ativos, vendidos)

Exemplos: "quantos machos?", "peso mÃ©dio?", "animais vacinados?"`;if(e.includes("quantos")||e.includes("quantidade")||e.includes("total"))return e.includes("macho")?`ğŸ‚ VocÃª tem **${t.machos}** machos no rebanho.`:e.includes("fÃªmea")||e.includes("femea")||e.includes("vaca")?`ğŸ„ VocÃª tem **${t.femeas}** fÃªmeas no rebanho.`:e.includes("ativo")?`âœ… VocÃª tem **${t.ativos}** animais ativos.`:e.includes("vendido")?`ğŸ’° VocÃª tem **${t.vendidos}** animais marcados como vendidos.`:e.includes("prenha")||e.includes("gestante")?`ğŸ¤° VocÃª tem **${t.prenhas}** matrizes com histÃ³rico de prenhez.`:`ğŸ“Š Total de **${t.total}** animais cadastrados (${t.machos} machos, ${t.femeas} fÃªmeas).`;if(e.includes("peso")){if(e.includes("mÃ©dio")||e.includes("medio"))return`âš–ï¸ O peso mÃ©dio do rebanho Ã© **${t.pesoMedio.toFixed(2)} kg**.`;if(e.includes("total"))return`âš–ï¸ O peso total do rebanho Ã© **${t.pesoTotal.toFixed(2)} kg** (${(t.pesoTotal/1e3).toFixed(2)} toneladas).`;if(e.includes("mais pesado")||e.includes("maior")){const i=t.maisPesado;return i?`ğŸ† O mais pesado Ã© **${i.nome||`brinco ${i.brinco}`}** com **${i.pesoKg} kg**.`:"Sem dados de peso."}if(e.includes("mais leve")||e.includes("menor")){const i=t.maisLeve;return i?`ğŸª¶ O mais leve Ã© **${i.nome||`brinco ${i.brinco}`}** com **${i.pesoKg} kg**.`:"Sem dados de peso."}return`âš–ï¸ Peso mÃ©dio: **${t.pesoMedio.toFixed(2)} kg** | Total: **${(t.pesoTotal/1e3).toFixed(2)} ton**`}if(e.includes("mais pesado")||e.includes("maior animal")){const i=t.maisPesado;return i?`ğŸ† O mais pesado Ã© **${i.nome||`brinco ${i.brinco}`}** com **${i.pesoKg} kg**.`:"Sem dados."}if(e.includes("mais leve")||e.includes("menor animal")){const i=t.maisLeve;return i?`ğŸª¶ O mais leve Ã© **${i.nome||`brinco ${i.brinco}`}** com **${i.pesoKg} kg**.`:"Sem dados."}if(e.includes("vacin")||e.includes("imuniz"))return`ğŸ’‰ **${t.comVacinacao}** de ${t.total} animais tÃªm registro de vacinaÃ§Ã£o (${(t.comVacinacao/t.total*100).toFixed(1)}%).`;if(e.includes("tratamento")||e.includes("medicamento")||e.includes("remÃ©dio")||e.includes("medicado"))return`ğŸ’Š **${t.comTratamento}** animais tÃªm histÃ³rico de tratamentos sanitÃ¡rios.`;if(e.includes("prenha")||e.includes("prenhez")||e.includes("gestante")||e.includes("gestaÃ§Ã£o"))return`ğŸ¤° **${t.prenhas}** matrizes tÃªm histÃ³rico de prenhez registrado.`;if(e.includes("cria")||e.includes("progÃªnie")||e.includes("progenie")||e.includes("filhote")||e.includes("bezerro"))return`ğŸ‘¶ **${t.comProgenie}** animais tÃªm registro de progÃªnie (crias).`;if(e.includes("reproduÃ§Ã£o")||e.includes("reproducao")||e.includes("reprodutivo"))return`ğŸ„ Dados reprodutivos:
â€¢ FÃªmeas: ${t.femeas}
â€¢ Com prenhez registrada: ${t.prenhas}
â€¢ Com progÃªnie: ${t.comProgenie}`;if(e.includes("raÃ§a")||e.includes("raca")||e.includes("raÃ§as"))return`ğŸ·ï¸ DistribuiÃ§Ã£o por raÃ§a:
${Object.entries(t.racas).sort((l,h)=>h[1]-l[1]).map(([l,h])=>`â€¢ ${l}: ${h}`).join(`
`)||"Nenhuma raÃ§a cadastrada."}`;if(e.includes("idade")){const i=s();return e.includes("mÃ©dia")||e.includes("media")?`ğŸ“… A idade mÃ©dia do rebanho Ã© **${i.toFixed(1)} meses** (${(i/12).toFixed(1)} anos).`:`ğŸ“… Idade mÃ©dia: **${i.toFixed(1)} meses**.`}if(e.includes("status")||e.includes("situaÃ§Ã£o"))return`ğŸ“‹ Status do rebanho:
â€¢ Ativos: ${t.ativos}
â€¢ Vendidos: ${t.vendidos}
â€¢ Total: ${t.total}`;if(e.includes("resumo")||e.includes("relatÃ³rio")||e.includes("visÃ£o geral")||e.includes("overview"))return`ğŸ“Š **Resumo do Rebanho:**
â€¢ Total: ${t.total} animais
â€¢ Machos: ${t.machos} | FÃªmeas: ${t.femeas}
â€¢ Peso mÃ©dio: ${t.pesoMedio.toFixed(2)} kg
â€¢ Com vacinaÃ§Ã£o: ${t.comVacinacao}
â€¢ Com tratamentos: ${t.comTratamento}
â€¢ Matrizes com prenhez: ${t.prenhas}`;if(e.includes("obrigado")||e.includes("valeu")||e.includes("thanks"))return"De nada! ğŸ„ Estou aqui para ajudar com o manejo do seu rebanho.";const r=v.get(`chat:${e}`);return r||`ğŸ¤” NÃ£o entendi sua pergunta. Tente perguntar sobre:
â€¢ Quantidade de animais
â€¢ Peso (mÃ©dio, total, mais pesado)
â€¢ VacinaÃ§Ã£o e tratamentos
â€¢ Prenhez e reproduÃ§Ã£o
â€¢ RaÃ§as
â€¢ Idade mÃ©dia

Ou digite "ajuda" para ver todas as opÃ§Ãµes.`}}};export{B as a,W as b,k as g,V as s};
