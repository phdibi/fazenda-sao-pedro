import{l as _,D as x,r as h,j as e}from"./index-OnCL7RT-.js";const y="https://api.open-meteo.com/v1",j=new Map,D=1800*1e3,b=t=>t===0?x.Ensolarado:t>=1&&t<=3?x.Nublado:t>=51&&t<=67?x.Chuvoso:t>=80&&t<=99?x.Tempestade:t>=71&&t<=77?x.Geada:x.Nublado,$=async(t,s,i=7)=>{const a=`${t},${s},${i}`,l=j.get(a);if(l&&Date.now()-l.timestamp<D)return l.data;try{const o=`${y}/forecast?latitude=${t}&longitude=${s}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode&timezone=America/Sao_Paulo&forecast_days=${i}`,n=await fetch(o);if(!n.ok)throw new Error("Erro ao buscar clima");const r=await n.json(),p=r.daily.time.map((m,d)=>({id:`weather-${m}`,date:new Date(m),location:`${t},${s}`,temperature:{min:r.daily.temperature_2m_min[d],max:r.daily.temperature_2m_max[d],avg:(r.daily.temperature_2m_max[d]+r.daily.temperature_2m_min[d])/2},humidity:0,precipitation:r.daily.precipitation_sum[d],condition:b(r.daily.weathercode[d])}));return j.set(a,{data:p,timestamp:Date.now()}),p}catch{return[]}},S=async(t,s)=>{const i=new Date,a=new Date(i.getTime()-720*60*60*1e3),l=o=>o.toISOString().split("T")[0];try{const o=`${y}/archive?latitude=${t}&longitude=${s}&start_date=${l(a)}&end_date=${l(i)}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode&timezone=America/Sao_Paulo`,n=await fetch(o);if(!n.ok)throw new Error("Erro ao buscar histÃ³rico");const r=await n.json();return r.daily.time.map((p,m)=>({id:`weather-hist-${p}`,date:new Date(p),location:`${t},${s}`,temperature:{min:r.daily.temperature_2m_min[m],max:r.daily.temperature_2m_max[m],avg:(r.daily.temperature_2m_max[m]+r.daily.temperature_2m_min[m])/2},humidity:0,precipitation:r.daily.precipitation_sum[m],condition:b(r.daily.weathercode[m])}))}catch{return[]}},C=t=>{const s=[];t.forEach(a=>{a.temperature.min<=3&&s.push({id:`alert-geada-${a.date.toISOString()}`,type:"geada",severity:a.temperature.min<=0?"high":"medium",message:`âš ï¸ Risco de geada em ${a.date.toLocaleDateString("pt-BR")}. Temperatura mÃ­nima: ${a.temperature.min}Â°C`,date:a.date,isRead:!1}),a.temperature.max>=38&&s.push({id:`alert-calor-${a.date.toISOString()}`,type:"calor_extremo",severity:a.temperature.max>=42?"high":"medium",message:`ðŸŒ¡ï¸ Calor extremo previsto para ${a.date.toLocaleDateString("pt-BR")}. MÃ¡xima: ${a.temperature.max}Â°C. Garanta Ã¡gua e sombra para o rebanho.`,date:a.date,isRead:!1}),a.precipitation>=50&&s.push({id:`alert-chuva-${a.date.toISOString()}`,type:"chuva_intensa",severity:a.precipitation>=80?"high":"medium",message:`ðŸŒ§ï¸ Chuva intensa prevista para ${a.date.toLocaleDateString("pt-BR")}. PrecipitaÃ§Ã£o: ${a.precipitation}mm`,date:a.date,isRead:!1})});const i=t.filter(a=>a.precipitation<1).length;return i>=7&&s.push({id:`alert-seca-${Date.now()}`,type:"seca",severity:i>=14?"high":"medium",message:`â˜€ï¸ PerÃ­odo seco detectado: ${i} dias sem chuva significativa. Monitore as pastagens.`,date:new Date,isRead:!1}),s},M=(t,s)=>{const i=new Map;s.forEach(o=>{const n=E(o.date);i.has(n)||i.set(n,{temps:[],precip:[],gmds:[]});const r=i.get(n);r.temps.push(o.temperature.avg),r.precip.push(o.precipitation)});const a=t.reduce((o,n)=>{const r=_(n).gmdTotal||0;return o+r},0)/(t.length||1),l=[];return i.forEach((o,n)=>{l.push({period:n,avgTemperature:T(o.temps),avgPrecipitation:A(o.precip),avgGMD:a,animalCount:t.length})}),l.sort((o,n)=>o.period.localeCompare(n.period))},E=t=>{const s=new Date(t),i=s.getFullYear(),a=Math.ceil((s.getDate()+new Date(s.getFullYear(),s.getMonth(),1).getDay())/7);return`${i}-S${a.toString().padStart(2,"0")}`},T=t=>t.length?t.reduce((s,i)=>s+i,0)/t.length:0,A=t=>t.reduce((s,i)=>s+i,0),u={latitude:-29.68,longitude:-53.81,name:"Rio Grande do Sul"},R=({animals:t=[],expanded:s=!1})=>{const[i,a]=h.useState([]),[l,o]=h.useState([]),[n,r]=h.useState(!0),[p,m]=h.useState(s);h.useEffect(()=>{if(i.length>0){r(!1);return}(async()=>{r(!0);try{const g=await $(u.latitude,u.longitude,7);a(g),o(C(g))}catch{}finally{r(!1)}})()},[]);const d=i[0],v=i.slice(1,p?7:4),f={Ensolarado:"â˜€ï¸",Nublado:"â˜ï¸",Chuvoso:"ðŸŒ§ï¸",Tempestade:"â›ˆï¸",Geada:"â„ï¸",Seco:"ðŸŒµ"},w={geada:"â„ï¸",seca:"â˜€ï¸",chuva_intensa:"ðŸŒ§ï¸",calor_extremo:"ðŸŒ¡ï¸"},N={low:"bg-yellow-900/30 border-yellow-700/50 text-yellow-400",medium:"bg-orange-900/30 border-orange-700/50 text-orange-400",high:"bg-red-900/30 border-red-700/50 text-red-400"};return n?e.jsx("div",{className:"bg-base-800 rounded-lg p-4 animate-pulse",children:e.jsx("div",{className:"h-20 bg-base-700 rounded"})}):d?e.jsxs("div",{className:"bg-base-800 rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"bg-gradient-to-r from-blue-900/50 to-cyan-900/50 p-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-400",children:u.name}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date().toLocaleDateString("pt-BR",{weekday:"long",day:"numeric",month:"long"})})]}),e.jsx("span",{className:"text-4xl",children:f[d.condition]||"ðŸŒ¤ï¸"})]}),e.jsxs("div",{className:"mt-3 flex items-end gap-4",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-4xl font-bold text-white",children:[Math.round(d.temperature.avg),"Â°C"]}),e.jsxs("p",{className:"text-sm text-gray-400",children:[Math.round(d.temperature.min),"Â° / ",Math.round(d.temperature.max),"Â°"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-400",children:d.condition}),d.precipitation>0&&e.jsxs("p",{className:"text-sm text-blue-400",children:["ðŸ’§ ",d.precipitation,"mm"]})]})]})]}),l.length>0&&e.jsx("div",{className:"px-4 py-2 space-y-2",children:l.slice(0,3).map(c=>e.jsxs("div",{className:`flex items-center gap-2 px-3 py-2 rounded border ${N[c.severity]}`,children:[e.jsx("span",{className:"text-lg",children:w[c.type]}),e.jsx("p",{className:"text-sm flex-1",children:c.message})]},c.id))}),e.jsxs("div",{className:"px-4 pb-4",children:[e.jsxs("div",{className:"flex justify-between items-center py-2",children:[e.jsx("p",{className:"text-sm text-gray-400",children:"PrÃ³ximos dias"}),e.jsx("button",{onClick:()=>m(!p),className:"text-xs text-brand-primary hover:underline",children:p?"Ver menos":"Ver mais"})]}),e.jsx("div",{className:"grid grid-cols-3 md:grid-cols-6 gap-2",children:v.map(c=>e.jsxs("div",{className:"bg-base-700 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-xs text-gray-400",children:new Date(c.date).toLocaleDateString("pt-BR",{weekday:"short"})}),e.jsx("span",{className:"text-xl my-1 block",children:f[c.condition]||"ðŸŒ¤ï¸"}),e.jsxs("p",{className:"text-xs text-white",children:[Math.round(c.temperature.min),"Â° / ",Math.round(c.temperature.max),"Â°"]}),c.precipitation>0&&e.jsxs("p",{className:"text-[10px] text-blue-400",children:[c.precipitation,"mm"]})]},c.id))})]}),l.length>0&&e.jsxs("div",{className:"px-4 pb-4 pt-2 border-t border-base-700",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"ðŸ’¡ Dicas de Manejo:"}),e.jsxs("ul",{className:"text-xs text-gray-400 space-y-1",children:[l.some(c=>c.type==="geada")&&e.jsx("li",{children:"â€¢ Proteja bezerros do frio intenso"}),l.some(c=>c.type==="calor_extremo")&&e.jsx("li",{children:"â€¢ Garanta sombra e Ã¡gua fresca disponÃ­vel"}),l.some(c=>c.type==="seca")&&e.jsx("li",{children:"â€¢ Monitore pastagens e considere suplementaÃ§Ã£o"}),l.some(c=>c.type==="chuva_intensa")&&e.jsx("li",{children:"â€¢ Verifique cercas e abrigos apÃ³s a chuva"})]})]})]}):e.jsx("div",{className:"bg-base-800 rounded-lg p-4 text-center text-gray-500",children:"NÃ£o foi possÃ­vel carregar dados do clima"})},k=({animals:t})=>{const[s,i]=h.useState([]),[a,l]=h.useState(!0);h.useEffect(()=>{(async()=>{try{const r=await S(u.latitude,u.longitude);i(r)}catch{}finally{l(!1)}})()},[]);const o=h.useMemo(()=>s.length?M(t,s):[],[t,s]);return a?e.jsx("div",{className:"animate-pulse h-40 bg-base-700 rounded"}):e.jsxs("div",{className:"bg-base-800 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"ðŸ“Š CorrelaÃ§Ã£o Clima x Performance"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-gray-400 text-left",children:[e.jsx("th",{className:"pb-2",children:"PerÃ­odo"}),e.jsx("th",{className:"pb-2",children:"Temp. MÃ©dia"}),e.jsx("th",{className:"pb-2",children:"PrecipitaÃ§Ã£o"}),e.jsx("th",{className:"pb-2",children:"GMD MÃ©dio"})]})}),e.jsx("tbody",{className:"text-white",children:o.map(n=>e.jsxs("tr",{className:"border-t border-base-700",children:[e.jsx("td",{className:"py-2",children:n.period}),e.jsxs("td",{className:"py-2",children:[n.avgTemperature.toFixed(1),"Â°C"]}),e.jsxs("td",{className:"py-2",children:[n.avgPrecipitation.toFixed(1),"mm"]}),e.jsxs("td",{className:"py-2",children:[n.avgGMD.toFixed(3)," kg/dia"]})]},n.period))})]})}),e.jsx("p",{className:"text-xs text-gray-500 mt-4",children:"* AnÃ¡lise baseada nos Ãºltimos 30 dias. GMD calculado com base nos animais cadastrados."})]})};export{R as W,k as a};
